name: Deploy to Railway

# WHEN THIS RUNS:
# - When code is pushed to 'main' or 'master' branch
# - Only after CI tests pass (that's why we use workflow_run)
on:
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types:
      - completed
    branches:
      - main
      - master

  # Also allow manual deployment from GitHub UI
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Railway
    runs-on: ubuntu-latest

    # IMPORTANT: Only deploy if CI tests passed
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      # STEP 1: Get the code
      - name: Checkout code
        uses: actions/checkout@v4

      # STEP 2: Install Railway CLI
      # This is Railway's command-line tool that lets us deploy from scripts
      - name: Install Railway CLI
        run: |
          curl -fsSL https://railway.app/install.sh | sh
          echo "Railway CLI installed successfully"

      # STEP 3: Deploy to Railway
      # Uses the Railway token stored in GitHub secrets
      # The 'railway up' command:
      #   - Builds your Docker image (using your Dockerfile)
      #   - Pushes it to Railway
      #   - Deploys the new version
      #   - Keeps old version running until new one is healthy
      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "üöÄ Starting deployment to Railway..."
          railway up --detach
          echo "‚úÖ Deployment initiated successfully"

      # STEP 4: Verify deployment
      # Wait a bit for the deployment to stabilize, then check health
      - name: Wait for deployment
        run: |
          echo "‚è≥ Waiting 30 seconds for deployment to stabilize..."
          sleep 30

      # STEP 5: Health check
      # This calls your /health endpoint to verify the app is running
      # Uses Railway's provided domain (you'll set this as a secret)
      - name: Health check
        run: |
          echo "üè• Checking application health..."
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.RAILWAY_APP_URL }}/health)
          if [ $response -eq 200 ]; then
            echo "‚úÖ Health check passed! App is running."
          else
            echo "‚ùå Health check failed with status code: $response"
            exit 1
          fi

      # STEP 6: Notify on success
      - name: Deployment successful
        run: |
          echo "üéâ Deployment completed successfully!"
          echo "üåê Application is live at: ${{ secrets.RAILWAY_APP_URL }}"
